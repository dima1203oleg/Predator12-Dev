---
name: "Backend Unhealthy Recovery"
description: "–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–µ–∑–¥–æ—Ä–æ–≤–æ–≥–æ backend —Å–µ—Ä–≤—ñ—Å—É"
version: "1.0"
triggers:
  - alert: "BackendDown"
  - alert: "HighErrorRate" 
  - health_check_failed: "backend"

steps:
  - name: "–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å—Ç–∞–Ω—É"
    type: "check"
    actions:
      - check_process: "python"
      - check_port: 5001
      - check_memory_usage: true
      - check_cpu_usage: true
    timeout: 30

  - name: "–°–ø—Ä–æ–±–∞ –º'—è–∫–æ–≥–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è"
    type: "soft_recovery"
    actions:
      - clear_redis_cache: "predator:*"
      - reload_config: true
      - garbage_collect: true
    timeout: 60
    
  - name: "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ—Å–ª—è –º'—è–∫–æ–≥–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è"
    type: "health_check"
    actions:
      - curl: "http://localhost:5001/health"
      - check_response_time: 5000
    success_condition: "status_code == 200"
    
  - name: "–†–µ—Å—Ç–∞—Ä—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
    type: "hard_recovery"
    condition: "previous_step_failed"
    actions:
      - docker_restart: "predator11-backend-1"
      - wait_for_health: 120
    timeout: 180
    
  - name: "–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ backup"
    type: "disaster_recovery"
    condition: "previous_step_failed"
    actions:
      - restore_from_backup: "latest"
      - rebuild_image: true
      - docker_restart: "predator11-backend-1"
    timeout: 300

notifications:
  on_start:
    - slack: "#alerts"
      message: "üö® AutoHeal: –†–æ–∑–ø–æ—á–∞—Ç–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è backend"
  on_success:
    - slack: "#alerts" 
      message: "‚úÖ AutoHeal: Backend –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ"
  on_failure:
    - slack: "#critical"
      message: "‚ùå AutoHeal: –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ backend. –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ä—É—á–Ω–∞ —ñ–Ω—Ç–µ—Ä–≤–µ–Ω—Ü—ñ—è."
    - pagerduty: "escalate"

rollback:
  enabled: true
  conditions:
    - "health_degraded_after_recovery"
    - "error_rate_increased"
  actions:
    - restore_previous_config
    - docker_restart
