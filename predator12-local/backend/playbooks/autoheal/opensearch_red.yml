---
name: "OpenSearch Red Status Recovery"
description: "–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è OpenSearch –ø—Ä–∏ red cluster status"
version: "1.0"
triggers:
  - alert: "OpenSearchClusterRed"
  - cluster_health: "red"
  - shard_allocation_failed: true

steps:
  - name: "–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ cluster —Å—Ç–∞–Ω—É"
    type: "analysis"
    actions:
      - get_cluster_health: "/_cluster/health"
      - get_allocation_explain: "/_cluster/allocation/explain"
      - check_disk_space: "/usr/share/opensearch/data"
      - get_indices_status: "/_cat/indices?v"
    timeout: 60

  - name: "–û—á–∏—â–µ–Ω–Ω—è –Ω–µ–ø—Ä–∏—Å–≤–æ—î–Ω–∏—Ö shards"
    type: "shard_recovery"
    condition: "unassigned_shards > 0"
    actions:
      - retry_allocation: "/_cluster/reroute?retry_failed=true"
      - force_allocation: "unassigned_primary_shards"
    timeout: 300

  - name: "–ó–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É"
    type: "cleanup"
    condition: "disk_usage > 85%"
    actions:
      - delete_old_indices: "older_than_7_days"
      - force_merge: "indices_with_many_segments"
      - clear_cache: "/_cache/clear"
    timeout: 600

  - name: "–ó–º–µ–Ω—à–µ–Ω–Ω—è JVM heap"
    type: "memory_optimization"
    condition: "memory_usage > 90%"
    actions:
      - reduce_jvm_heap: "256m"
      - restart_opensearch: true
      - wait_for_green: 180
    timeout: 300

  - name: "–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ä–µ–ø–ª—ñ–∫"
    type: "replica_management"
    condition: "insufficient_nodes"
    actions:
      - set_replicas: 0
      - wait_for_yellow: 120
    timeout: 180

  - name: "–ü–æ–≤–Ω–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç –∫–ª–∞—Å—Ç–µ—Ä–∞"
    type: "cluster_restart"
    condition: "previous_steps_failed"
    actions:
      - stop_opensearch: true
      - clear_cluster_state: "/usr/share/opensearch/data/nodes"
      - start_opensearch: true
      - wait_for_cluster: 300
    timeout: 600

recovery_policies:
  data_loss_acceptable: false
  max_downtime_minutes: 10
  prioritize_availability: true

monitoring:
  post_recovery:
    - cluster_health_check: "every_30_seconds_for_5_minutes"
    - performance_baseline: "compare_with_pre_incident"
    - alert_if_degraded: true

notifications:
  on_start:
    - slack: "#ops"
      message: "üîç AutoHeal: –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ OpenSearch red status"
  on_recovery:
    - slack: "#ops"
      message: "üü¢ AutoHeal: OpenSearch –ø–æ–≤–µ—Ä–Ω—É—Ç–æ –¥–æ green status"
  on_failure:
    - slack: "#critical"
      message: "üî¥ AutoHeal: OpenSearch –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ red status. –ü–æ—Ç—Ä—ñ–±–Ω–∞ –µ–∫—Å–ø–µ—Ä—Ç–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞."
    - page_oncall: true
